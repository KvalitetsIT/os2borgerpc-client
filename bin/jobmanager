#!/usr/bin/env python3

import os
import pkg_resources
import random
import semver
import sys
import subprocess

try:
    from os2borgerpc.client.updater import (  # noqa: F401
        update_client,
    )
    from os2borgerpc.client.jobmanager import update_and_run  # noqa: E402
except ImportError:
    # If any of the imports fail, reinstall the client
    try:
        subprocess.check_call(
            [
                sys.executable,
                "-m",
                "pip",
                "install",
                "--force-reinstall",
                "os2borgerpc-client",
            ]
        )
        sys.exit(0)
    except subprocess.CalledProcessError:
        print("Restoring client failed\n", file=sys.stderr)

# Higher values: Check for updates less often
UPDATE_FREQUENCY = 200

if not os.geteuid() == 0:
    sys.exit("\n Only root can run this program. \n")

# Perform an update-check with a random interval.
if random.randint(1, UPDATE_FREQUENCY) == 1:
    update_client()

update_and_run()
